<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Realtime JA‚ÜíEN Translation</title>
  <style>
    /* ========== ÂÖ®‰Ωì„É¨„Ç§„Ç¢„Ç¶„Éà ========== */
    html, body {
      height: 100%;
      margin: 0;
      background: #121212;
      color: #eaeaea;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
    }
    .wrap {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* ========== „Éò„ÉÉ„ÉÄ„ÉºÔºà„Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢Ôºâ ========== */
    header {
      padding: 12px 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid #2a2a2a;
      flex-wrap: wrap;
      background: #1a1a1a;
    }
    header button {
      background: #2d6cdf;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
    }
    header button:hover {
      background: #2558b8;
    }
    header button.secondary {
      background: #444;
    }
    header button.secondary:hover {
      background: #555;
    }
    header button.danger {
      background: #c53030;
    }
    header button.danger:hover {
      background: #9b2c2c;
    }
    /* Èå≤Èü≥‰∏≠„ÅÆ„Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
    header button#startBtn.recording {
      background: #e53e3e;
      animation: pulse 1.5s ease-in-out infinite;
      box-shadow: 0 0 10px rgba(229, 62, 62, 0.5);
    }
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        box-shadow: 0 0 10px rgba(229, 62, 62, 0.5);
      }
      50% {
        opacity: 0.8;
        box-shadow: 0 0 20px rgba(229, 62, 62, 0.8);
      }
    }
    header select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #1b1b1b;
      color: #eee;
      font-size: 14px;
    }
    header select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #0f0f0f;
    }
    #status {
      flex: 1;
      min-width: 150px;
      font-size: 13px;
      color: #aaa;
      font-weight: 500;
    }
    #status.recording {
      color: #fc8181;
      font-weight: 600;
    }

    /* ========== „É°„Ç§„É≥„Ç®„É™„Ç¢ÔºàÁøªË®≥ÁµêÊûúË°®Á§∫Ôºâ ========== */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    #translation-output {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      line-height: 1.8;
      white-space: pre-wrap;
      word-wrap: break-word;
      scroll-behavior: smooth;
    }

    /* ÊñáÂ≠ó„Çµ„Ç§„Ç∫„ÅÆ„ÇØ„É©„Çπ */
    #translation-output.size-small { font-size: 18px; }
    #translation-output.size-medium { font-size: 28px; }
    #translation-output.size-large { font-size: 42px; }
    #translation-output.size-xlarge { font-size: 56px; }

    /* „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºË°®Á§∫ */
    #translation-output:empty::before {
      content: "English translation will appear here...";
      color: #555;
      font-style: italic;
    }

    /* ========== „Éï„ÉÉ„Çø„Éº ========== */
    footer {
      padding: 8px 16px;
      font-size: 12px;
      color: #777;
      border-top: 1px solid #2a2a2a;
      background: #1a1a1a;
      text-align: center;
    }

    /* ========== „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Çπ„Çø„Ç§„É´ÔºàWebkitÁ≥ª„Éñ„É©„Ç¶„Ç∂Ôºâ ========== */
    #translation-output::-webkit-scrollbar {
      width: 10px;
    }
    #translation-output::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    #translation-output::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 5px;
    }
    #translation-output::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <!-- Èå≤Èü≥ÈñãÂßã/ÂÅúÊ≠¢„Éú„Çø„É≥ -->
      <button id="startBtn" onclick="toggleRecording()">Start Recording</button>

      <!-- „ÇØ„É™„Ç¢„Éú„Çø„É≥ -->
      <button class="danger" onclick="clearTranslation()">Clear</button>

      <!-- ÁøªË®≥È†ªÂ∫¶ÈÅ∏Êäû -->
      <label for="segmentInterval" style="color: #aaa; font-size: 13px;">Interval:</label>
      <select id="segmentInterval">
        <option value="5000">5 sec</option>
        <option value="10000">10 sec</option>
        <option value="15000" selected>15 sec</option>
        <option value="20000">20 sec</option>
      </select>

      <!-- ÊñáÂ≠ó„Çµ„Ç§„Ç∫ÈÅ∏Êäû -->
      <label for="fontSize" style="color: #aaa; font-size: 13px;">Font Size:</label>
      <select id="fontSize" onchange="changeFontSize()">
        <option value="small">Small (18px)</option>
        <option value="medium" selected>Medium (28px)</option>
        <option value="large">Large (42px)</option>
        <option value="xlarge">X-Large (56px)</option>
      </select>

      <!-- „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ -->
      <span id="status">Ready</span>
    </header>

    <main>
      <!-- ÁøªË®≥ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ -->
      <div id="translation-output" class="size-medium"></div>
    </main>

    <footer>
      Real-time Japanese ‚Üí English Translation | WebSocket connected to localhost:8000
    </footer>
  </div>

  <script>
    // ========== „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ==========
    let mediaRecorder = null;
    let ws = null;
    let isRecording = false;
    let mime = '';

    // WebSocket URL
    function getWsUrl() {
      return 'ws://localhost:8000/ws';
    }

    // ========== MediaRecorder„ÅÆ„Çµ„Éù„Éº„Éà„Åô„ÇãMIME„Çø„Ç§„Éó„ÇíÈÅ∏Êäû ==========
    function chooseMimeType() {
      const candidates = [
        'audio/webm;codecs=opus',
        'audio/webm',
        'audio/ogg;codecs=opus',
        'audio/ogg',
        'audio/wav'
      ];
      for (const c of candidates) {
        if (MediaRecorder.isTypeSupported(c)) return c;
      }
      return '';
    }

    // ========== Èå≤Èü≥ÈñãÂßã/ÂÅúÊ≠¢„Éà„Ç∞„É´ ==========
    async function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        await startRecording();
      }
    }

    // ========== Èå≤Èü≥ÈñãÂßã ==========
    async function startRecording() {
      if (isRecording) return;

      try {
        // 1) WebSocketÊé•Á∂ö
        const url = getWsUrl();
        ws = new WebSocket(url);
        ws.binaryType = 'arraybuffer';

        ws.onopen = () => {
          // console.log('WebSocket connected:', url);
          updateStatus('WebSocket connected');
          // „Çµ„Éº„ÉêÂÅ¥„ÅÆ„Éê„ÉÉ„Éï„Ç°„Çí„É™„Çª„ÉÉ„Éà
          try { ws.send('reset'); } catch {}
        };

        ws.onclose = () => {
          // console.log('WebSocket closed');
          updateStatus('WebSocket closed');
        };

        ws.onerror = (e) => {
          // console.error('WebSocket error', e);
          updateStatus('WebSocket error');
        };

        ws.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            // console.log('[DEBUG] Received WebSocket message:', data);
            if (data.status === "processing") {
              // Ignore processing status messages (keepalive)
              // console.log('[DEBUG] Processing status received');
              return;
            } else if (data.english !== undefined) {
              // console.log('[DEBUG] English translation received:', data.english);
              appendTranslation('', data.english);
            } else if (data.error) {
              console.error('Server error:', data.error);
              updateStatus('Error: ' + data.error);
            }
          } catch (err) {
            // console.warn('Non-JSON message:', ev.data);
          }
        };

        // 2) „Éû„Ç§„ÇØÂèñÂæó
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mime = chooseMimeType();
        mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : undefined);

        // „Çµ„Éº„Éê„Å∏MIME„Éí„É≥„Éà„ÇíÈÄÅ„Çã
        try {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ mime }));
          }
        } catch {}

        // 3) MediaRecorder„ÅÆ„Éá„Éº„ÇøÈÄÅ‰ø°
        // onstopÊôÇ„Å´ÂÆåÂÖ®„Å™WebM„Éï„Ç°„Ç§„É´„ÇíÈÄÅ‰ø°„Åô„ÇãÊñπÂºè„Å´Â§âÊõ¥
        let recordingTimeout = null;

        mediaRecorder.addEventListener('dataavailable', async (ev) => {
          // console.log('[DEBUG] dataavailable event fired, size:', ev.data?.size);
          if (!ev.data || ev.data.size === 0) {
            // console.warn('[DEBUG] Empty audio data, skipping');
            return;
          }
          if (!ws || ws.readyState !== WebSocket.OPEN) {
            // console.warn('[DEBUG] WebSocket not open, state:', ws?.readyState);
            return;
          }
          const buf = await ev.data.arrayBuffer();
          // console.log('[DEBUG] Sending audio chunk, bytes:', buf.byteLength);
          ws.send(buf); // „Éê„Ç§„Éä„É™„Çí /ws „Å∏ÈÄÅ‰ø°
        });

        // ÈÅ∏Êäû„Åï„Çå„ÅüÈñìÈöî„Åß„Éá„Éº„Çø„ÇíÂå∫Âàá„Å£„Å¶ÈÄÅ‰ø°
        const segmentSelect = document.getElementById('segmentInterval');
        const segmentMs = parseInt(segmentSelect.value);

        // MediaRecorder„ÇíËá™ÂãïÁöÑ„Å´ÂÅúÊ≠¢/ÂÜçËµ∑Âãï„Åó„Å¶ÂÆåÂÖ®„Å™WebM„ÉÅ„É£„É≥„ÇØ„ÇíÁîüÊàê
        function scheduleRecordingCycle() {
          if (!isRecording || !mediaRecorder) return;

          window.recordingTimeout = setTimeout(() => {
            if (!isRecording || !mediaRecorder || mediaRecorder.state !== 'recording') return;

            // console.log('[DEBUG] Stopping MediaRecorder to finalize chunk...');
            mediaRecorder.stop();

            // „Éá„Éº„Çø„ÅåÈÄÅ‰ø°„Åï„Çå„Çã„Åæ„ÅßÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçËµ∑Âãï
            setTimeout(() => {
              if (!isRecording || !mediaRecorder) return;
              // console.log('[DEBUG] Restarting MediaRecorder...');
              mediaRecorder.start();
              scheduleRecordingCycle();
            }, 100);
          }, segmentMs);
        }

        mediaRecorder.start();
        isRecording = true;
        scheduleRecordingCycle();

        // UI„ÇíÊõ¥Êñ∞
        const startBtn = document.getElementById('startBtn');
        const statusEl = document.getElementById('status');
        const fontSizeSelect = document.getElementById('fontSize');

        startBtn.textContent = 'Stop Recording';
        startBtn.classList.add('recording');
        statusEl.classList.add('recording');

        // Èå≤Èü≥‰∏≠„ÅØË®≠ÂÆöÂ§âÊõ¥„ÇíÁÑ°ÂäπÂåñ
        segmentSelect.disabled = true;
        fontSizeSelect.disabled = true;

        updateStatus(`üî¥ Recording... (${mime || 'default'}, ${segmentMs / 1000}s chunks)`);

      } catch (error) {
        console.error('Failed to start recording:', error);
        updateStatus('Error: ' + error.message);
        alert('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      }
    }

    // ========== Èå≤Èü≥ÂÅúÊ≠¢ ==========
    function stopRecording() {
      if (!isRecording) return;

      // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„Çí„ÇØ„É™„Ç¢
      if (window.recordingTimeout) {
        clearTimeout(window.recordingTimeout);
        window.recordingTimeout = null;
      }

      try {
        if (mediaRecorder) {
          mediaRecorder.stop();
          // „Éû„Ç§„ÇØ„Çπ„Éà„É™„Éº„É†„ÇíÂÅúÊ≠¢
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
      } catch {}

      mediaRecorder = null;
      isRecording = false;

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send('stop'); // „Çµ„Éº„Éê„Å´ÁµÇ‰∫Ü„ÇíÈÄöÁü•
        ws.close();
      }
      ws = null;

      // UI„ÇíÊõ¥Êñ∞
      const startBtn = document.getElementById('startBtn');
      const statusEl = document.getElementById('status');
      const segmentSelect = document.getElementById('segmentInterval');
      const fontSizeSelect = document.getElementById('fontSize');

      startBtn.textContent = 'Start Recording';
      startBtn.classList.remove('recording');
      statusEl.classList.remove('recording');

      // Èå≤Èü≥ÂÅúÊ≠¢ÊôÇ„ÅØË®≠ÂÆöÂ§âÊõ¥„ÇíÊúâÂäπÂåñ
      segmentSelect.disabled = false;
      fontSizeSelect.disabled = false;

      updateStatus('Stopped');
    }

    // ========== ÁøªË®≥ÁµêÊûú„Çí„É™„Ç¢„É´„Çø„Ç§„É†„ÅßËøΩË®ò ==========
    function appendTranslation(japaneseText, englishText) {
      const outputEl = document.getElementById('translation-output');

      // Ëã±Ë™û„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø‰ΩøÁî®
      const trimmedText = (englishText || '').trim();

      // Á©∫„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
      if (!trimmedText) return;

      // ÂêÑ„ÉÅ„É£„É≥„ÇØ„ÇíÁã¨Á´ã„Åó„Å¶Ë°®Á§∫ÔºàÁ¥ØÁ©ç„Å™„ÅóÔºâ
      // ÊîπË°å„É≠„Ç∏„ÉÉ„ÇØ: „Éî„É™„Ç™„Éâ„ÄÅÁñëÂïèÁ¨¶„ÄÅÊÑüÂòÜÁ¨¶„ÅÆÂæå„Å´„Çπ„Éö„Éº„Çπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊîπË°å
      const processedText = trimmedText.replace(/([.!?])\s+/g, '$1\n');

      if (outputEl.textContent) {
        // „Çπ„Éö„Éº„Çπ„ÇíËøΩÂä†„Åó„Å¶ÈÄ£Áµê
        outputEl.textContent += ' ' + processedText;
      } else {
        outputEl.textContent = processedText;
      }

      // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    // ========== ÁøªË®≥ÁµêÊûú„Çí„ÇØ„É™„Ç¢ ==========
    function clearTranslation() {
      const outputEl = document.getElementById('translation-output');
      outputEl.textContent = '';
      updateStatus('Translation output cleared');
    }

    // ========== ÊñáÂ≠ó„Çµ„Ç§„Ç∫Â§âÊõ¥ ==========
    function changeFontSize() {
      const outputEl = document.getElementById('translation-output');
      const select = document.getElementById('fontSize');
      const size = select.value;

      // Êó¢Â≠ò„ÅÆ„Çµ„Ç§„Ç∫„ÇØ„É©„Çπ„ÇíÂâäÈô§
      outputEl.classList.remove('size-small', 'size-medium', 'size-large', 'size-xlarge');

      // Êñ∞„Åó„ÅÑ„Çµ„Ç§„Ç∫„ÇØ„É©„Çπ„ÇíËøΩÂä†
      outputEl.classList.add('size-' + size);
    }

    // ========== „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞ ==========
    function updateStatus(message) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
    }

    // ========== ÂàùÊúüÂåñ ==========
    window.addEventListener('DOMContentLoaded', () => {
      updateStatus('Ready. Click "Start Recording" to begin.');
    });

    // ========== „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó ==========
    window.addEventListener('beforeunload', () => {
      if (isRecording) {
        stopRecording();
      }
    });
  </script>
</body>
</html>
