<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Realtime JA→EN Translation</title>
  <style>
    /* ========== 全体レイアウト ========== */
    html, body {
      height: 100%;
      margin: 0;
      background: #121212;
      color: #eaeaea;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
    }
    .wrap {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    /* ========== ヘッダー（コントロールエリア） ========== */
    header {
      padding: 12px 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 1px solid #2a2a2a;
      flex-wrap: wrap;
      background: #1a1a1a;
    }
    header button {
      background: #2d6cdf;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
    }
    header button:hover {
      background: #2558b8;
    }
    header button.secondary {
      background: #444;
    }
    header button.secondary:hover {
      background: #555;
    }
    header button.danger {
      background: #c53030;
    }
    header button.danger:hover {
      background: #9b2c2c;
    }
    /* 録音中のスタートボタンのスタイル */
    header button#startBtn.recording {
      background: #38a169;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    header select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #1b1b1b;
      color: #eee;
      font-size: 14px;
    }
    #status {
      flex: 1;
      min-width: 150px;
      font-size: 13px;
      color: #aaa;
    }

    /* ========== メインエリア（2カラム表示） ========== */
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px;
      overflow: hidden;
      position: relative;
      background: #2a2a2a;
    }

    .output-panel {
      display: flex;
      flex-direction: column;
      background: #121212;
      overflow: hidden;
    }

    .panel-header {
      padding: 12px 16px;
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      color: #aaa;
    }

    .panel-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      line-height: 1.8;
      white-space: pre-wrap;
      word-wrap: break-word;
      scroll-behavior: smooth;
    }

    /* 文字サイズのクラス */
    .panel-content.size-small { font-size: 18px; }
    .panel-content.size-medium { font-size: 28px; }
    .panel-content.size-large { font-size: 42px; }
    .panel-content.size-xlarge { font-size: 56px; }

    /* プレースホルダー表示 */
    .panel-content:empty::before {
      color: #555;
      font-style: italic;
    }
    #japanese-output:empty::before {
      content: "日本語の文字起こしがここに表示されます...";
    }
    #english-output:empty::before {
      content: "English translation will appear here...";
    }

    /* ========== フッター ========== */
    footer {
      padding: 8px 16px;
      font-size: 12px;
      color: #777;
      border-top: 1px solid #2a2a2a;
      background: #1a1a1a;
      text-align: center;
    }

    /* ========== スクロールバーのスタイル（Webkit系ブラウザ） ========== */
    .panel-content::-webkit-scrollbar {
      width: 10px;
    }
    .panel-content::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    .panel-content::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 5px;
    }
    .panel-content::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <!-- 録音開始/停止ボタン -->
      <button id="startBtn" onclick="toggleRecording()">Start Recording</button>

      <!-- クリアボタン -->
      <button class="danger" onclick="clearTranslation()">Clear</button>

      <!-- 文字サイズ選択 -->
      <label for="fontSize" style="color: #aaa; font-size: 13px;">Font Size:</label>
      <select id="fontSize" onchange="changeFontSize()">
        <option value="small">Small (18px)</option>
        <option value="medium" selected>Medium (28px)</option>
        <option value="large">Large (42px)</option>
        <option value="xlarge">X-Large (56px)</option>
      </select>

      <!-- ステータス表示 -->
      <span id="status">Ready</span>
    </header>

    <main>
      <!-- 左側: 日本語文字起こし -->
      <div class="output-panel">
        <div class="panel-header">日本語 (Japanese)</div>
        <div id="japanese-output" class="panel-content size-medium"></div>
      </div>

      <!-- 右側: 英語翻訳 -->
      <div class="output-panel">
        <div class="panel-header">英語 (English)</div>
        <div id="english-output" class="panel-content size-medium"></div>
      </div>
    </main>

    <footer>
      Real-time Japanese → English Translation | WebSocket connected to localhost:8000
    </footer>
  </div>

  <script>
    // ========== グローバル変数 ==========
    let mediaRecorder = null;
    let ws = null;
    let isRecording = false;
    let mime = '';
    const SEGMENT_MS = 10000; // 音声チャンク送信間隔（ミリ秒）: 10秒ごと

    // WebSocket URL
    function getWsUrl() {
      return 'ws://localhost:8000/ws';
    }

    // ========== MediaRecorderのサポートするMIMEタイプを選択 ==========
    function chooseMimeType() {
      const candidates = [
        'audio/webm;codecs=opus',
        'audio/webm',
        'audio/ogg;codecs=opus',
        'audio/ogg',
        'audio/wav'
      ];
      for (const c of candidates) {
        if (MediaRecorder.isTypeSupported(c)) return c;
      }
      return '';
    }

    // ========== 録音開始/停止トグル ==========
    async function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        await startRecording();
      }
    }

    // ========== 録音開始 ==========
    async function startRecording() {
      if (isRecording) return;

      // 録音開始時に前回のテキスト履歴をリセット
      lastDisplayedJapanese = '';
      lastDisplayedEnglish = '';

      try {
        // 1) WebSocket接続
        const url = getWsUrl();
        ws = new WebSocket(url);
        ws.binaryType = 'arraybuffer';

        ws.onopen = () => {
          console.log('WebSocket connected:', url);
          updateStatus('WebSocket connected');
          // サーバ側のバッファをリセット
          try { ws.send('reset'); } catch {}
        };

        ws.onclose = () => {
          console.log('WebSocket closed');
          updateStatus('WebSocket closed');
        };

        ws.onerror = (e) => {
          console.error('WebSocket error', e);
          updateStatus('WebSocket error');
        };

        ws.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            if (data.japanese !== undefined && data.english !== undefined) {
              appendTranslation(data.japanese, data.english);
            } else if (data.error) {
              console.error('Server error:', data.error);
              updateStatus('Error: ' + data.error);
            }
          } catch (err) {
            console.warn('Non-JSON message:', ev.data);
          }
        };

        // 2) マイク取得
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mime = chooseMimeType();
        mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : undefined);

        // サーバへMIMEヒントを送る
        try {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ mime }));
          }
        } catch {}

        // 3) MediaRecorderのデータ送信
        mediaRecorder.addEventListener('dataavailable', async (ev) => {
          if (!ev.data || ev.data.size === 0) return;
          if (!ws || ws.readyState !== WebSocket.OPEN) return;
          const buf = await ev.data.arrayBuffer();
          ws.send(buf); // バイナリを /ws へ送信
        });

        // SEGMENT_MSごとにデータを区切って送信
        mediaRecorder.start(SEGMENT_MS);
        isRecording = true;

        // UIを更新
        const startBtn = document.getElementById('startBtn');
        startBtn.textContent = 'Stop Recording';
        startBtn.classList.add('recording');
        updateStatus(`Recording... (${mime || 'default'}, ${SEGMENT_MS / 1000}s chunks)`);

      } catch (error) {
        console.error('Failed to start recording:', error);
        updateStatus('Error: ' + error.message);
        alert('マイクへのアクセスに失敗しました。ブラウザの設定を確認してください。');
      }
    }

    // ========== 録音停止 ==========
    function stopRecording() {
      if (!isRecording) return;

      try {
        if (mediaRecorder) {
          mediaRecorder.stop();
          // マイクストリームを停止
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
      } catch {}

      mediaRecorder = null;
      isRecording = false;

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send('stop'); // サーバに終了を通知
        ws.close();
      }
      ws = null;

      // UIを更新
      const startBtn = document.getElementById('startBtn');
      startBtn.textContent = 'Start Recording';
      startBtn.classList.remove('recording');
      updateStatus('Stopped');
    }

    // ========== 前回表示したテキストを保持（重複除外用） ==========
    let lastDisplayedJapanese = '';
    let lastDisplayedEnglish = '';

    // ========== 翻訳結果をリアルタイムで追記（日本語と英語を同期） ==========
    function appendTranslation(japaneseText, englishText) {
      const japaneseEl = document.getElementById('japanese-output');
      const englishEl = document.getElementById('english-output');

      // 全体をtrimして空チェック
      const trimmedJa = (japaneseText || '').trim();
      const trimmedEn = (englishText || '').trim();

      // 両方とも空なら何もしない
      if (!trimmedJa && !trimmedEn) return;

      // 日本語テキストの処理
      let newJaText = '';
      if (trimmedJa && trimmedJa !== lastDisplayedJapanese) {
        // 前回のテキストが新しいテキストの先頭に含まれている場合は差分のみ取得
        if (lastDisplayedJapanese && trimmedJa.startsWith(lastDisplayedJapanese)) {
          // 差分を取得（trimせずに空白も保持）
          newJaText = trimmedJa.substring(lastDisplayedJapanese.length);
          // 先頭の空白のみ削除（句点などは保持）
          newJaText = newJaText.replace(/^\s+/, '');
        } else {
          newJaText = trimmedJa;
        }
      }

      // 英語テキストの処理
      let newEnText = '';
      if (trimmedEn && trimmedEn !== lastDisplayedEnglish) {
        // 前回のテキストが新しいテキストの先頭に含まれている場合は差分のみ取得
        if (lastDisplayedEnglish && trimmedEn.startsWith(lastDisplayedEnglish)) {
          // 差分を取得（trimせずに空白も保持）
          newEnText = trimmedEn.substring(lastDisplayedEnglish.length);
          // 先頭の空白のみ削除
          newEnText = newEnText.replace(/^\s+/, '');
        } else {
          newEnText = trimmedEn;
        }
      }

      // 日本語を表示
      if (newJaText) {
        // 日本語は句読点で改行（全角・半角両方に対応、スペース不要）
        const processedJa = newJaText.replace(/([。！？!?])/g, '$1\n');
        if (japaneseEl.textContent) {
          japaneseEl.textContent += '\n' + processedJa;
        } else {
          japaneseEl.textContent = processedJa;
        }
        // 自動スクロール
        japaneseEl.scrollTop = japaneseEl.scrollHeight;
        // 最後に表示したテキストを更新
        lastDisplayedJapanese = trimmedJa;
      }

      // 英語を表示
      if (newEnText) {
        // 改行ロジック: ピリオド、疑問符、感嘆符の後にスペースがある場合は改行
        const processedEn = newEnText.replace(/([.!?])\s+/g, '$1\n');
        if (englishEl.textContent) {
          englishEl.textContent += '\n' + processedEn;
        } else {
          englishEl.textContent = processedEn;
        }
        // 自動スクロール
        englishEl.scrollTop = englishEl.scrollHeight;
        // 最後に表示したテキストを更新
        lastDisplayedEnglish = trimmedEn;
      }
    }

    // ========== 翻訳結果をクリア ==========
    function clearTranslation() {
      const japaneseEl = document.getElementById('japanese-output');
      const englishEl = document.getElementById('english-output');
      japaneseEl.textContent = '';
      englishEl.textContent = '';
      // 前回表示テキストもリセット
      lastDisplayedJapanese = '';
      lastDisplayedEnglish = '';
      updateStatus('Translation output cleared');
    }

    // ========== 文字サイズ変更 ==========
    function changeFontSize() {
      const japaneseEl = document.getElementById('japanese-output');
      const englishEl = document.getElementById('english-output');
      const select = document.getElementById('fontSize');
      const size = select.value;

      // 既存のサイズクラスを削除
      japaneseEl.classList.remove('size-small', 'size-medium', 'size-large', 'size-xlarge');
      englishEl.classList.remove('size-small', 'size-medium', 'size-large', 'size-xlarge');

      // 新しいサイズクラスを追加
      japaneseEl.classList.add('size-' + size);
      englishEl.classList.add('size-' + size);
    }

    // ========== ステータス更新 ==========
    function updateStatus(message) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
    }

    // ========== 初期化 ==========
    window.addEventListener('DOMContentLoaded', () => {
      updateStatus('Ready. Click "Start Recording" to begin.');
    });

    // ========== ページ離脱時のクリーンアップ ==========
    window.addEventListener('beforeunload', () => {
      if (isRecording) {
        stopRecording();
      }
    });
  </script>
</body>
</html>
